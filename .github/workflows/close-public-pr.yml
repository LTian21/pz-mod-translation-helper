name: Close Public PR After Merge

on:
  pull_request:
    types: [closed]

env:
  PUBLIC_REPO_FULL_NAME: "Laotian21/PZ-Mod-Translation-Hub"

jobs:
  sync_close_to_public_repo:
    # æ ¸å¿ƒé€»è¾‘ï¼šä»…å½“ PR è¢«åˆå¹¶ (merged) ä¸”å…¶æºåˆ†æ”¯åä»¥ 'public-pr-' å¼€å¤´æ—¶æ‰è¿è¡Œ
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'public-pr-')
    runs-on: ubuntu-latest

    steps:
      - name: Extract Public PR Number from Branch Name
        id: pr_details
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          PUBLIC_PR_NUMBER=${BRANCH_NAME#public-pr-}
          echo "Extracted Public PR Number: ${PUBLIC_PR_NUMBER}"
          echo "PUBLIC_PR_NUMBER=${PUBLIC_PR_NUMBER}" >> "$GITHUB_OUTPUT"

      - name: Comment on and Close the Public PR
        env:
          # æ­¤ä»¤ç‰Œå¿…é¡»æ‹¥æœ‰å¯¹å…¬å¼€ä»“åº“çš„ 'repo' æƒé™
          GH_TOKEN: ${{ secrets.PUBLIC_REPO_TOKEN }}
        run: |
          set -e
          PUBLIC_PR_NUMBER="${{ steps.pr_details.outputs.PUBLIC_PR_NUMBER }}"
          PRIVATE_MERGE_COMMIT_SHA="${{ github.event.pull_request.merge_commit_sha }}"

          # ã€ä¼˜åŒ–ã€‘ä½¿ç”¨ heredoc æ ¼å¼åŒ–å¤šè¡Œè¯„è®ºï¼Œæ›´å®‰å…¨å¯é 
          MESSAGE_BODY=$(cat <<EOF | sed 's/^[ ]*//')
          ğŸ‰ æ„Ÿè°¢æ‚¨çš„è´¡çŒ®ï¼

          æ‚¨çš„ Pull Request å·²è¢«åˆå¹¶åˆ°æˆ‘ä»¬çš„ä¸»ä»“åº“ä¸­ï¼Œå¹¶å°†åŒ…å«åœ¨æœªæ¥çš„å…¬å¼€å‘å¸ƒé‡Œã€‚

          *æ‚¨å¯ä»¥åœ¨æ­¤æäº¤è®°å½•ä¸­è¿½è¸ªæ‚¨çš„æ›´æ”¹ï¼š\`${PRIVATE_MERGE_COMMIT_SHA}\`*

          æˆ‘ä»¬æœŸå¾…æ‚¨çš„ä¸‹ä¸€æ¬¡è´¡çŒ®ï¼
          EOF
          )
          
          echo "Commenting on Public PR #${PUBLIC_PR_NUMBER} in repo ${{ env.PUBLIC_REPO_FULL_NAME }}..."
          gh pr comment "${PUBLIC_PR_NUMBER}" \
            --repo "${{ env.PUBLIC_REPO_FULL_NAME }}" \
            --body "$MESSAGE_BODY"

          echo "Closing Public PR #${PUBLIC_PR_NUMBER}..."
          gh pr close "${PUBLIC_PR_NUMBER}" \
            --repo "${{ env.PUBLIC_REPO_FULL_NAME }}" || true
          
          echo "Public PR #${PUBLIC_PR_NUMBER} has been successfully closed and commented on."